{% load about_me %}
{% include 'base.html' %}
{% block content %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">

<head>
    <link href="{% about_me 'css/full_search.css' %}" rel="stylesheet" media="all">
    <link href="{% about_me 'css/material-design-iconic-font.css' %}" rel="stylesheet" media="all">
    <link href="{% about_me 'css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
/* Custom CSS styles for the input group */
.my-custom-input-group {
  background-color: #a8f5cd;
  border: 1px solid #151414;
  padding: 10px;
  border-radius: 5px;
}
/* Define the normal link color */



</style>


</head>


<body>
    <div class="page-wrapper bg-img-1 p-t-200 p-b-120" style="background: url(&quot;{% about_me 'img/bg-img-01.jpg' %}&quot;) center / cover no-repeat;">
        <div class="wrapper wrapper--w900">
            <div class="card card-4">
                <div class="card-body">


                  <ul class="tab-list">
                    <li style="margin-left: 15px;" class="tab-list__item">
                      <a href="{% url 'med_search' %}" data-toggle="tab" id="drugSearchLink"><h3 style="color: azure;">DRUG SEARCH</h3></a>
                    </li>
                    <li style="margin-left: 150px;" class="tab-list__item">
                      <a href="{% url 'medicine_details' %}" data-toggle="tab" id="drugDetailsLink"><h3 style="color: azure;">DRUG DETAILS</h3></a>
                    </li>
                  </ul>
                  


                    <div class="tab-content">

                        <div class="tab-pane active" id="tab1">
                            <form method="POST" id="med_search_form" action="#">
                                {% csrf_token %} 

                                <div id="name-container" class="input-group input-group-big">
                                    <label class="label">provide the name of drug:</label>
                                    <input  type="text" class="input--style-1" id="name-" name="name" value="{{ name_of_medication }}" placeholder="NAME OF THE DRUG e.g:NAPA" required="required" oninput="showWordRecommendations()">
                                    <i class="input-group-symbol">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" viewBox="0 0 16 16" class="bi bi-capsule">
                                            <path d="M1.828 8.9 8.9 1.827a4 4 0 1 1 5.657 5.657l-7.07 7.071A4 4 0 1 1 1.827 8.9Zm9.128.771 2.893-2.893a3 3 0 1 0-4.243-4.242L6.713 5.429l4.243 4.242Z"></path>
                                        </svg>
                                    </i>
                                </div>


                                <div class="row row-space">

                                  
                                    <div  class="col-2" >
                                      <div class="input-group">
                                        <label class="label">select the drug:</label>
                                        <div class="input-group-icon" id="js-select-special">

                                          <div class="rs-select2 js-select-simple select--no-search">

                                            <div style="margin-bottom: 5px" id="wordRecommendations"></div>

                                          </div>  
                                        </div>
                                      </div>
                                    </div>


                                    
                                    <div class="col-2">

                                    </div>

                                </div>


                                <div class="row row-space">


                                    <div class="col-2">





                                    </div>

                                    <div class="col-2">
                                        <button style="margin-top: 5px"  class="btn-submit" type="submit">SEARCH MEDICINE</button>
                                    </div>
                                </div>



                            </form>
                        </div>


                    </div>
                </div>
            </div>
        </div>
    </div>
</body>

<script src="{% about_me 'js/search_med_details.js' %}"></script>

<script>
var numNameFields = 1;

function addNameField() {
    var nameContainer = document.getElementById("name-container");
    var nameFieldContainer = document.createElement("div");
    nameFieldContainer.className = "mb-3 input-group"; // Added 'input-group' class to ensure proper alignment

    var newInput = document.createElement("input");
    newInput.className = "form-control";
    newInput.type = "text";
    newInput.name = "name";
    newInput.id = "name-" + numNameFields;
    newInput.value = "";
    newInput.required = true;
    newInput.oninput = function(event) {
        showWordRecommendations(event, numNameFields);
    };

    var deleteButton = document.createElement("button");
    deleteButton.type = "button";
    deleteButton.className = "btn btn-danger";
    deleteButton.textContent = "Remove";
    deleteButton.onclick = function() {
        removeNameField(newInput.id);
    };

    nameFieldContainer.appendChild(newInput);
    nameFieldContainer.appendChild(deleteButton);
    nameContainer.appendChild(nameFieldContainer);
    numNameFields++;
}

// Function to remove the clicked name field
function removeNameField(inputId) {
    var nameContainer = document.getElementById("name-container");
    var inputToRemove = document.getElementById(inputId);
    nameContainer.removeChild(inputToRemove.parentElement); // Remove the parent div containing the input and delete button
}

// Global variable to store timeout references for each name field
var timeouts = {};

function showWordRecommendations(event, fieldNum) {
    var input = event.target.value.trim();

    // Check if there is any input
    if (input.length === 0) {
        document.getElementById("wordRecommendations").innerHTML = "";
        return;
    }

    // Clear previous timeout, if any
    clearTimeout(timeouts[fieldNum]);

    // Set a new timeout to fetch word recommendations after a brief delay (e.g., 300ms)
    timeouts[fieldNum] = setTimeout(function() {
        // Make an AJAX call to fetch word recommendations based on the input
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/get_word_recommendations/?input=' + encodeURIComponent(input), true);
        xhr.onload = function() {
            if (xhr.status === 200) {
                var wordRecommendations = JSON.parse(xhr.responseText);

                // Display word recommendations in a list
                var recommendationsHtml = " <select onchange='selectRecommendation()'>";
                recommendationsHtml += '<option>CAN SELECT MATCHING DRUG NAME</option>';
                for (var i = 0; i < wordRecommendations.length; i++) {
                    var word = wordRecommendations[i];
                    recommendationsHtml += '<option value="' + word + '">' + word + '</option>';
                }
                recommendationsHtml += "</select>";

                document.getElementById("wordRecommendations").innerHTML = recommendationsHtml;
            } else {
                console.error('Request failed. Status:', xhr.status);
                // Display no recommendations for error cases
                document.getElementById("wordRecommendations").innerHTML = "";
            }
        };
        xhr.onerror = function() {
            console.error('Request failed. Network error');
            // Display no recommendations for network errors
            document.getElementById("wordRecommendations").innerHTML = "";
        };
        xhr.send();
    }, 300); // Adjust the delay as needed (in milliseconds)
}

// Function to select a word recommendation and populate the input field with it
function selectRecommendation() {
    var selectElement = document.querySelector("select");
    var selectedOption = selectElement.options[selectElement.selectedIndex].value;
    document.getElementById("name-" + (numNameFields - 1)).value = selectedOption;
    document.getElementById("wordRecommendations").innerHTML = "";
}



function handleFormSubmit(event) {
event.preventDefault(); // Prevent the form from being submitted traditionally
handleSelectionChange();
}





  function toggleMatchingGroups() {
  var matchingGroups = document.querySelectorAll(".full-details");
  for (var i = 0; i < matchingGroups.length; i++) {
    matchingGroups[i].classList.toggle("hidden");
  }
}

// Attach the toggle function to the button's click event
var toggleButton = document.getElementById("toggleButton");
toggleButton.addEventListener("click", toggleMatchingGroups);

function togglefullresults() {
  var full_result = document.querySelectorAll(".full-result");
  for (var i = 0; i < full_result.length; i++) {
    full_result[i].classList.toggle("hidden");
  }
}

var full_result_button = document.getElementById("full_result_button");
full_result_button.addEventListener("click", togglefullresults);






function handleSelectionChange() {
  var nameInputs = document.querySelectorAll("#name-container input");
    var drugNames = [];
    for (var i = 0; i < nameInputs.length; i++) {
      drugNames.push(encodeURIComponent(nameInputs[i].value));
    }

// Make an AJAX call to fetch the medication details based on the selected strength, dosage form, and drug name
var xhr = new XMLHttpRequest();
xhr.open('GET', '/get_presciption_classification_beta/?name=' + drugNames , true);
xhr.onload = function() {
  if (xhr.status === 200) {
    var get_presciption_classification = JSON.parse(xhr.responseText);

    // Assuming 'data' contains the JSON response from the server
    const drugClassGroups = get_presciption_classification.drug_class_groups;
    const allMachGroups = get_presciption_classification.all_mach_groups;
    const allMachGroups2 = get_presciption_classification.all_mach_groups_2;
    const all_groups_uniques = get_presciption_classification.all_matching_uniques;

    // // Now you can use these variables as needed
    console.log(all_groups_uniques);
    // console.log(allMachGroups);
    // console.log(allMachGroups2);
    // console.log(all_groups_uniques);

    if (Array.isArray(drugClassGroups) && drugClassGroups.length > 0) {
    // Display details for each medication
    var detailsHtml = "";
    var matchingGroupsFound = false;

    function areAllArraysEmpty(arr) {
      return arr.every(innerArr => innerArr.length === 0);
    }

    if (!areAllArraysEmpty(all_groups_uniques)) {
      matchingGroupsFound = true;
      detailsHtml += "<h4> ALL MATCHING GROUPS </h4>";
      detailsHtml += "<div class='medication-details'>";
      detailsHtml += "<p><strong>classified related drugs: </strong>" + all_groups_uniques[0] + "</p>";
      detailsHtml += "<p><strong>ALL MATCHING HEADINGS: </strong>" + all_groups_uniques[1] + "</p>";
      if (all_groups_uniques[2].length > 0) {
        detailsHtml += "<p><strong>ALL MATCHING SPECIFIC CLASS: </strong>" + all_groups_uniques[2] + "</p>";
      }
      detailsHtml += "</div>";
    }

    if (!matchingGroupsFound) {
      detailsHtml += "<h4> NO MATCHING GROUPS </h4>";
    }

      

// i have to hide after this section

    if (allMachGroups2) {
      for (var i = 0; i < allMachGroups2.length; i++) {
        var medication = allMachGroups2[i];
        // console.log(medication);
        detailsHtml += "<div class='medication-details full-details hidden'>";
        detailsHtml += "<h6> DETAILED OBSERVATION OF MATCH </h6>";
        detailsHtml += "<p><strong>MATCHING COUPLE: </strong>" + medication.name1 + "&" + medication.name2 + "</p>";
        detailsHtml += "<h4> MACHING  ISSUES </h4>";

        if (medication.heading_matches && medication.specific_class_matches.length > 0) {
          detailsHtml += "<p><strong>SPECIFIC ISSUES: </strong>" + medication.specific_class_matches + "</p>";
        }
        else{
          detailsHtml += "<p><strong>PREDICTED ISSUES: </strong>" + medication.heading_matches + "</p>";
        }
        detailsHtml += "</div>";
      }
}


    if (allMachGroups) {
      for (var i = 0; i < allMachGroups.length; i++) {
        var medication = allMachGroups[i];
        detailsHtml += "<div class='medication-details full-details hidden'>";
        detailsHtml += "<p><strong>MATCHING COUPLE: </strong>" + medication.name1 + "&" + medication.name2 + "</p>";
        detailsHtml += "<h4> MACHING  ISSUES </h4>";

        if (medication.heading_matches && medication.specific_class_matches.length > 0) {
          detailsHtml += "<p><strong>SPECIFIC ISSUES: </strong>" + medication.specific_class_matches + "</p>";
        }
        else{
          detailsHtml += "<p><strong>PREDICTED ISSUES: </strong>" + medication.heading_matches + "</p>";
        }
        detailsHtml += "</div>";
      }
}

var all_headings = new Set(); // Move the declaration outside the loop

for (var i = 0; i < drugClassGroups.length; i++) {
  var medication = drugClassGroups[i];

  if (medication.heading && medication.specific_class.length > 0) {
    var headings = medication.heading.split(",");
    var specificClasses = medication.specific_class.split(",");

    for (var j = 0; j < headings.length; j++) {
      var heading_matches = headings[j].toUpperCase();
      var specific_class_matches = specificClasses[j].toUpperCase();
      console.log(specific_class_matches);
      all_headings.add(specific_class_matches);
    }
  } else {
    var heading_matches = headings[j].toUpperCase();
    var specific_class_matches = specificClasses[j].toUpperCase();
    all_headings.add(heading_matches);
  }

  detailsHtml += "<div class='full-result medication-details hidden'>";
  detailsHtml += "<p><strong>DRUG NAME: </strong>" + medication.name.toUpperCase() + "</p>";
  detailsHtml += "<p><strong>HEADINGS: </strong>" + Array.from(all_headings) + "</p>";
  detailsHtml += "</div>";
}





    detailsHtml += "</div>";

    // Display the details on the page
    document.getElementById("get_presciption_classification").innerHTML = detailsHtml;
  } else {
    console.error(xhr.responseText);
  }

  } else {
    console.error(xhr.statusText);
  }

};
xhr.onerror = function() {
  console.error('Request failed. Network error');
  // Display "No data found" message for network errors
  document.getElementById("get_presciption_classification").innerHTML = "<p>No data found</p>";
};
xhr.send();
}


  $(document).ready(function () {
  $("#drugSearchLink, #drugDetailsLink").on("click", function (e) {
    e.preventDefault(); // Prevent the default behavior

    // Get the URL from the link's href attribute
    var url = $(this).attr("href");

    // Navigate to the specified URL
    window.location.href = url;
  });
});

</script>
</html>
{% endblock %}
