{% load about_me %}
{% include 'base.html' %}
{% block content %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="en">

<head>


    <link href="{% about_me 'css/full_search.css' %}" rel="stylesheet" media="all">
    <link href="{% about_me 'css/material-design-iconic-font.css' %}" rel="stylesheet" media="all">
    <link href="{% about_me 'css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">
    <link rel="stylesheet" href="{% about_me 'css/custom.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>

.my_coll-2 {
    width: -webkit-calc(100% - 20px);
    width: -moz-calc(100% - 20px);
    width: calc(100% - 20px);
  }
  
  @media (max-width: 1700px) {
  .my_coll-2 {
      width: 100%;
    }
  }



</style>



</head>


<body>
    <div class="page-wrapper " style="background: url(&quot;{% about_me 'img/bg-img-01.jpg' %}&quot;) center / cover no-repeat;">
        <div style="margin-left: 15px">


                    <div class="tab-content">

                        <div id="tab1">




                                <div class="row row-space">

                                  
                                    <div style="margin-top: 25px"  class="col-2" >

                                      <select class ='input-group input-group-big' id="sortOption">
                                        <option value="default">Default</option>
                                        <option value="priceAsc">Price (Low to High)</option>
                                        <option value="priceDesc">Price (High to Low)</option>
                                      </select>
                                      
                                    </div>


                                    
                                    <div class="col-2">

                                    <!-- In your HTML, add this wherever you want to display the pagination control -->
                                    <div id="pagination"></div>

                                    <!-- Add buttons to navigate to different pages -->
                                    <button onclick="showPage(1, totalPages)">First</button>
                                    <button onclick="showPage(currentPage - 1, totalPages)">Previous</button>
                                    <button onclick="showPage(currentPage + 1, totalPages)">Next</button>
                                    <button onclick="showPage(totalPages, totalPages)">Last</button>


                                    </div>

                                </div>




                                  <div class ='row row-space' id="medicationDetails"></div>







                                
                                


                        </div>

















                    </div>
                </div>
            </div>


            
</body>

<!-- <script src="{% about_me 'js/search_results.js' %}"></script> -->
<script>


  // Retrieve the query parameters from the URL
  const urlParams = new URLSearchParams(window.location.search);
  const strength = urlParams.get('strength');
  const dosageForm = urlParams.get('dosage_form');
  const drugName = urlParams.get('name');
  
  // Now you have the values of the query parameters in the variables (strength, dosageForm, drugName).
  // You can use these values as needed in the JavaScript code of this HTML page.
  console.log('Strength:', strength);
  console.log('Dosage Form:', dosageForm);
  console.log('Drug Name:', drugName);




document.getElementById("sortOption").addEventListener("change", handleSortOptionChange);

function handleSortOptionChange() {
  var selectedSortOption = document.getElementById("sortOption").value;
  // Call the function to fetch medication details with the updated sort option
  fetchMedicationDetails(selectedSortOption);
}

var currentPage = 1; // Declare currentPage in the global scope
function fetchMedicationDetails(sortOption) {
  // Make an AJAX call to fetch the medication details based on the selected strength, dosage form, and drug name
  var xhr = new XMLHttpRequest();
  xhr.open('GET', '/get_medication/?strength=' + strength + '&dosage_form=' + dosageForm + '&name=' + drugName, true);
  // xhr.open('GET', '/get_medication/?strength=' + strength + '&dosage_form=' + dosageForm + '&name=' + drugName + '&sort=' + sortOption, true);

  xhr.onload = function() {
    if (xhr.status === 200) {
      var medicationDetails = JSON.parse(xhr.responseText);
      if (Array.isArray(medicationDetails) && medicationDetails.length > 0) {
        // Sort the medication details based on the selected sort option
        
        if (sortOption === "priceAsc") {
          medicationDetails.sort(function(a, b) {
            return a.price_analysis - b.price_analysis;
          });
        } else if (sortOption === "priceDesc") {
          medicationDetails.sort(function(a, b) {
            return b.price_analysis - a.price_analysis;
          });
        }
        
        var detailsHtml = "";
        var startIndex = (currentPage - 1) * 10;
        var endIndex = startIndex + 10;
        for (var i = startIndex; i < endIndex && i < medicationDetails.length; i++) {
          var medication = medicationDetails[i];
          detailsHtml += 
          
                  `
                  

                      <div class="row row-space">
                        <div  class="my_coll" >
                        <table class="table  widget-26">
                          <tbody>
                            <tr>
                              <td>
                                <div class="widget-26-job-title">
                                  <a href="#">${medication.name.trim()}</a>
                                  <p class="m-0">
                                    <a href="#" >${medication.dosage_form.trim()}.</a>
                                  </p>
                                </div>
                              </td>
                              <td class="column-2" >
                                <div class="widget-26-job-info">
                                  <p class="type m-0">${medication.manufacturer.trim()}</p>
                                  <a  class="type m-0 employer-name">${medication.generic_name.trim()}.</a>
                                </div>
                              </td>
                              
                              
                              
                              `

          if(medication.price != '0'){
            detailsHtml += `<td class="column-3" >
                                <div>
                                    <p class="m-0 text-center Class">PRICE: ${medication.price.trim()} </p>
                                </div>
                            </td>`
          }
            else{
            detailsHtml += ` <td class="column-3">
                     <div class="widget-26-job-category">
                       <p class="m-0 text-center Class">PRICE DATA IS UNAVAILABLE</p>
                     </div>
                    </td>`
            }

          detailsHtml += `  </tr>
                          </tbody>
                        </table>
                    </div>
                  </div>

                


          `
        }
        document.getElementById("medicationDetails").innerHTML = detailsHtml;
      } else {
        // Display "No data found" message
        document.getElementById("medicationDetails").innerHTML = "<p>No data found</p>";
      }
    } else {
      console.error('Request failed. Status:', xhr.status);
      // Display "No data found" message for error cases
      document.getElementById("medicationDetails").innerHTML = "<p>No data found</p>";
    }
  };
  xhr.onerror = function() {
    console.error('Request failed. Network error');
    // Display "No data found" message for network errors
    document.getElementById("medicationDetails").innerHTML = "<p>No data found</p>";
  };
  xhr.send();
}

function generatePaginationControl(currentPage, totalPages) {
  var paginationHtml = '<div class="pagination">';
  
  // Previous button
  if (currentPage > 1) {
    paginationHtml += '<button onclick="showPage(' + (currentPage - 1) + ')">Previous</button>';
  }
  
  // Page numbers
  for (var i = 1; i <= totalPages; i++) {
    if (i === currentPage) {
      paginationHtml += '<button class="active">' + i + '</button>';
    } else {
      paginationHtml += '<button onclick="showPage(' + i + ')">' + i + '</button>';
    }
  }
  
  // Next button
  if (currentPage < totalPages) {
    paginationHtml += '<button onclick="showPage(' + (currentPage + 1) + ')">Next</button>';
  }
  
  paginationHtml += '</div>';
  
  return paginationHtml;
}
function displayPage(pageNumber) {
  currentPage = pageNumber;
  fetchMedicationDetails("priceAsc", currentPage);
}

// Function to calculate total pages based on medicationDetails length and items per page
function calculateTotalPages(itemsPerPage) {
  var totalMedications = medicationDetails.length;
  return Math.ceil(totalMedications / itemsPerPage);
}

// Call this function whenever you update the content or navigate to a new page
function updatePaginationControl(currentPage, totalPages) {
  var paginationControl = generatePaginationControl(currentPage, totalPages);
  document.getElementById("pagination").innerHTML = paginationControl;
}

// Function to show a specific page
function showPage(pageNumber, totalPages) {
  displayPage(pageNumber);
  // Update the pagination control
  updatePaginationControl(currentPage, totalPages);
}

// Example usage:
var medicationDetails = []; // Replace this with your actual medicationDetails array
var itemsPerPage = 10; // Number of medications to display per page

// Call this after fetching medicationDetails
var totalPages = calculateTotalPages(itemsPerPage);
displayPage(currentPage);

// Calculate totalPages after fetching the data and update pagination control
updatePaginationControl(currentPage, totalPages);

</script>

</html>
{% endblock %}
